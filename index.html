<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Rel√≥gio Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- jsPDF para gerar o cat√°logo -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        apple: {
                            bg: '#F5F5F7',
                            card: '#FFFFFF',
                            text: '#1D1D1F',
                            textMut: '#86868B',
                            border: '#D2D2D7'
                        },
                        brand: {
                            50: '#ecfdf5', 100: '#d1fae5', 400: '#34d399',
                            500: '#10b981', 600: '#059669', 800: '#065f46',
                            900: '#064e3b'
                        },
                        vip: { 50: '#faf5ff', 100: '#f3e8ff', 500: '#a855f7', 600: '#9333ea', 900: '#581c87' }
                    },
                    fontFamily: { 
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'] 
                    },
                    boxShadow: {
                        'apple': '0 4px 24px rgba(0, 0, 0, 0.04)',
                        'apple-hover': '0 10px 40px rgba(0, 0, 0, 0.08)',
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)'
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #D2D2D7; border-radius: 10px; border: 2px solid #FFFFFF; }
        ::-webkit-scrollbar-thumb:hover { background: #86868B; }
        
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin 1.5s linear infinite; }
        
        /* Checkbox Apple Style */
        .apple-checkbox {
            appearance: none; background-color: transparent; margin: 0; font: inherit; color: currentColor;
            width: 1.4em; height: 1.4em; border: 1.5px solid #D2D2D7; border-radius: 50%;
            display: grid; place-content: center; cursor: pointer; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .apple-checkbox::before {
            content: ""; width: 0.7em; height: 0.7em; transform: scale(0); transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em white; background-color: white; transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .apple-checkbox:checked { background-color: #059669; border-color: #059669; }
        .apple-checkbox:checked::before { transform: scale(1); }

        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .bg-mesh {
            background-color: #f9f9fb;
            background-image: radial-gradient(at 40% 20%, hsla(28,100%,74%,0.15) 0px, transparent 50%),
                              radial-gradient(at 80% 0%, hsla(189,100%,56%,0.15) 0px, transparent 50%),
                              radial-gradient(at 0% 50%, hsla(355,100%,93%,0.15) 0px, transparent 50%);
        }

        /* Notifica√ß√µes Toasts */
        .toast-enter { transform: translateX(100%); opacity: 0; }
        .toast-enter-active { transform: translateX(0); opacity: 1; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .toast-exit { transform: translateX(0); opacity: 1; }
        .toast-exit-active { transform: translateX(100%); opacity: 0; transition: all 0.3s ease-in; }
    </style>
</head>
<body class="bg-apple-bg text-apple-text font-sans h-screen flex overflow-hidden selection:bg-brand-100 selection:text-brand-900">

    <!-- Container de Notifica√ß√µes -->
    <div id="toast-container" class="fixed top-6 right-6 z-[400] flex flex-col gap-3 pointer-events-none"></div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white/90 backdrop-blur-md z-[300] flex flex-col items-center justify-center text-apple-text transition-opacity duration-500">
        <i class="ph ph-circle-notch text-5xl text-brand-500 animate-spin mb-6 font-light"></i>
        <h2 class="text-2xl font-semibold tracking-tight">A preparar o seu espa√ßo...</h2>
        <p class="text-apple-textMut text-sm mt-2 font-medium" id="global-loading-text">Sincronizando dados...</p>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 bg-mesh z-[200] flex items-center justify-center text-apple-text hidden">
        <div class="glass-panel p-10 rounded-[2.5rem] shadow-glass w-full max-w-sm flex flex-col items-center fade-in border border-white/60">
            <img src="https://erp.grupotuguir.com.br/img/Logo_GrupoTuguir.png" alt="Grupo Tuguir" class="h-16 mb-8 object-contain drop-shadow-md">
            
            <div class="w-full space-y-5">
                <div class="space-y-1.5">
                    <label class="text-xs font-semibold text-apple-textMut uppercase tracking-wider pl-1">E-mail</label>
                    <input type="email" id="login-email" class="w-full bg-white/50 border border-apple-border rounded-2xl px-4 py-3 text-sm focus:ring-2 focus:ring-brand-400 focus:bg-white outline-none transition-all duration-300" placeholder="Insira o seu e-mail">
                </div>
                <div class="space-y-1.5">
                    <label class="text-xs font-semibold text-apple-textMut uppercase tracking-wider pl-1">Palavra-passe</label>
                    <input type="password" id="login-password" class="w-full bg-white/50 border border-apple-border rounded-2xl px-4 py-3 text-sm focus:ring-2 focus:ring-brand-400 focus:bg-white outline-none transition-all duration-300" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                
                <button onclick="fazerLogin()" id="btn-login" class="w-full bg-apple-text text-white font-medium py-3.5 rounded-2xl hover:bg-black hover:shadow-lg transition-all duration-300 mt-2">
                    Iniciar Sess√£o
                </button>
                <p id="login-error" class="text-red-500 text-sm text-center hidden font-medium bg-red-50/50 p-2 rounded-xl"></p>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="w-64 bg-transparent flex flex-col hidden md:flex h-full shrink-0 relative z-0">
        <div class="p-8 pb-4 flex items-center justify-center">
            <img src="https://erp.grupotuguir.com.br/img/Logo_GrupoTuguir.png" alt="Grupo Tuguir" class="h-10 object-contain drop-shadow-sm hover:scale-105 transition-transform duration-300">
        </div>
        
        <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto" id="main-nav">
            <!-- Nav Items Generated by JS -->
        </nav>
        
        <div class="p-6 mt-auto">
            <div class="glass-panel rounded-2xl p-3 flex items-center justify-between border border-apple-border/50 shadow-sm">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-brand-400 to-brand-600 flex items-center justify-center text-white font-bold shadow-sm">
                        AT
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-apple-text">Atendimento</p>
                        <p class="text-xs font-medium text-apple-textMut" id="clock-display">00:00</p>
                    </div>
                </div>
                <button onclick="fazerLogout()" class="text-apple-textMut hover:text-red-500 p-2 transition-colors rounded-full hover:bg-red-50" title="Sair">
                    <i class="ph ph-sign-out text-xl"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content Area (Floating White Panel) -->
    <main class="flex-1 flex flex-col h-full py-4 pr-4 pl-0 relative z-10">
        <div class="bg-white h-full w-full rounded-[2rem] shadow-apple flex flex-col overflow-hidden border border-apple-border/30 relative">
            
            <!-- Header -->
            <header class="h-20 flex items-center justify-between px-8 shrink-0 border-b border-apple-border/30 bg-white/80 backdrop-blur-md sticky top-0 z-20">
                <h2 id="page-title" class="text-2xl font-bold text-apple-text tracking-tight">Vis√£o Geral</h2>
                <div class="flex items-center gap-3" id="global-actions">
                    <button onclick="openImportModal()" class="bg-apple-bg hover:bg-gray-200 text-apple-text px-5 py-2.5 rounded-full text-sm font-semibold flex items-center gap-2 transition-colors">
                        <i class="ph ph-upload-simple text-lg"></i> Importar Dados
                    </button>
                    <button onclick="openNovoLeadModal()" class="bg-apple-text hover:bg-black text-white px-5 py-2.5 rounded-full text-sm font-semibold flex items-center gap-2 transition-all shadow-sm hover:shadow-md">
                        <i class="ph ph-plus-bold text-lg"></i> Novo Registo
                    </button>
                </div>
            </header>
            
            <!-- Dynamic Content -->
            <div id="app-content" class="flex-1 overflow-y-auto p-8 relative scroll-smooth bg-white"></div>
            
        </div>
    </main>

    <!-- Modals -->
    <!-- Modal Novo Lead -->
    <div id="modal-novo-lead" class="fixed inset-0 bg-black/20 backdrop-blur-md hidden items-center justify-center z-50 transition-opacity">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-2xl m-4 overflow-hidden slide-up border border-white/50">
            <div class="px-8 py-6 border-b border-apple-border/30 flex justify-between items-center bg-white/80 backdrop-blur-sm">
                <h3 class="font-bold text-xl text-apple-text tracking-tight">Registar Contacto</h3>
                <button onclick="closeModal('modal-novo-lead')" class="bg-apple-bg hover:bg-gray-200 p-2 rounded-full transition-colors text-apple-textMut"><i class="ph ph-x text-lg"></i></button>
            </div>
            <div class="p-8 grid grid-cols-2 gap-6 bg-white">
                <div class="col-span-2 sm:col-span-1">
                    <label class="text-xs font-semibold text-apple-textMut uppercase tracking-wider pl-1">Nome / Empresa *</label>
                    <input type="text" id="fnome" class="w-full bg-apple-bg border-none rounded-2xl px-4 py-3 mt-1.5 text-sm focus:ring-2 focus:ring-brand-400 outline-none transition-all">
                </div>
                <div class="col-span-2 sm:col-span-1">
                    <label class="text-xs font-semibold text-apple-textMut uppercase tracking-wider pl-1">Telefone *</label>
                    <input type="text" id="ftel" class="w-full bg-apple-bg border-none rounded-2xl px-4 py-3 mt-1.5 text-sm focus:ring-2 focus:ring-brand-400 outline-none transition-all">
                </div>
                <div class="col-span-2 sm:col-span-1">
                    <label class="text-xs font-semibold text-apple-textMut uppercase tracking-wider pl-1">Tipo de Cliente</label>
                    <select id="ftipo" class="w-full bg-apple-bg border-none rounded-2xl px-4 py-3 mt-1.5 text-sm focus:ring-2 focus:ring-brand-400 outline-none transition-all appearance-none cursor-pointer">
                        <option value="Normal">Normal</option><option value="VIP">VIP</option>
                    </select>
                </div>
                <div class="col-span-2 sm:col-span-1">
                    <label class="text-xs font-semibold text-apple-textMut uppercase tracking-wider pl-1">Origem / Categoria</label>
                    <select id="forigem" class="w-full bg-apple-bg border-none rounded-2xl px-4 py-3 mt-1.5 text-sm focus:ring-2 focus:ring-brand-400 outline-none transition-all appearance-none cursor-pointer">
                        <option value="Novo Contato">Novo Contato (Org√¢nico)</option>
                        <option value="Comprado">Lead Comprado</option>
                        <option value="Carrinho Abandonado">Carrinho Abandonado</option>
                    </select>
                </div>
            </div>
            <div class="px-8 py-6 border-t border-apple-border/30 bg-apple-bg/50 flex justify-end gap-3">
                <button onclick="closeModal('modal-novo-lead')" class="px-6 py-2.5 bg-white text-apple-text font-semibold rounded-full border border-apple-border hover:bg-gray-50 transition-colors">Cancelar</button>
                <button onclick="salvarNovoLead()" class="px-6 py-2.5 bg-apple-text text-white font-semibold rounded-full hover:bg-black transition-all shadow-sm">Guardar Registo</button>
            </div>
        </div>
    </div>

    <!-- Modal Importa√ß√£o -->
    <div id="modal-import" class="fixed inset-0 bg-black/20 backdrop-blur-md hidden items-center justify-center z-50 transition-opacity">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-2xl m-4 overflow-hidden slide-up border border-white/50 flex flex-col max-h-[90vh]">
            <div class="px-8 py-6 border-b border-apple-border/30 flex justify-between items-center bg-white/80 backdrop-blur-sm shrink-0">
                <h3 class="font-bold text-xl text-apple-text tracking-tight">Importar Dados ao Sistema</h3>
                <button onclick="closeModal('modal-import')" class="bg-apple-bg hover:bg-gray-200 p-2 rounded-full transition-colors text-apple-textMut"><i class="ph ph-x text-lg"></i></button>
            </div>
            
            <div class="p-8 overflow-y-auto space-y-8 bg-white flex-1">
                
                <!-- M√âTODO 1: LER DA PASTA -->
                <div class="bg-blue-50/50 border border-blue-200 rounded-2xl p-6 relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 text-blue-100"><i class="ph-fill ph-folder text-9xl"></i></div>
                    <div class="relative z-10">
                        <h4 class="font-bold text-blue-900 text-lg flex items-center gap-2 mb-2"><i class="ph ph-folder-open"></i> Puxar da Pasta</h4>
                        <p class="text-sm text-blue-700 mb-5 font-medium">Deixe os ficheiros na mesma pasta deste sistema web e clique para puxar. <br><span class="text-xs text-blue-600 opacity-80">(Pode falhar consoante a seguran√ßa do seu navegador. Se falhar, use o m√©todo abaixo).</span></p>
                        
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button onclick="puxarDaPasta('clientes.csv', 'clientes', 'Normal')" class="flex-1 bg-white hover:bg-blue-50 text-blue-700 border border-blue-200 py-3 px-4 rounded-xl font-bold text-sm transition-all shadow-sm flex items-center justify-center gap-2 group">
                                <i class="ph ph-users text-lg group-hover:scale-110 transition-transform"></i> Puxar clientes.csv
                            </button>
                            <button onclick="puxarDaPasta('leads.csv', 'leads', 'Normal')" class="flex-1 bg-white hover:bg-blue-50 text-blue-700 border border-blue-200 py-3 px-4 rounded-xl font-bold text-sm transition-all shadow-sm flex items-center justify-center gap-2 group">
                                <i class="ph ph-funnel text-lg group-hover:scale-110 transition-transform"></i> Puxar leads.csv
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <div class="h-px bg-apple-border flex-1"></div>
                    <span class="text-xs font-bold text-apple-textMut uppercase tracking-widest">OU</span>
                    <div class="h-px bg-apple-border flex-1"></div>
                </div>

                <!-- M√âTODO 2: COLAR DADOS -->
                <div class="bg-apple-bg/30 border border-apple-border/50 rounded-2xl p-6">
                    <h4 class="font-bold text-apple-text text-lg flex items-center gap-2 mb-2"><i class="ph ph-clipboard-text"></i> Copiar e Colar (Garantido)</h4>
                    <p class="text-sm text-apple-textMut mb-5 font-medium">Abra o seu Excel ou CSV, copie tudo (Ctrl+C) e cole na caixa abaixo (Ctrl+V).</p>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="col-span-2 md:col-span-1">
                            <label class="text-xs font-semibold text-apple-textMut uppercase tracking-wider pl-1">Layout dos Dados</label>
                            <select id="colar-layout" class="w-full bg-white border border-apple-border rounded-xl px-4 py-2.5 mt-1.5 text-sm outline-none transition-all cursor-pointer">
                                <option value="clientes">Base de Clientes (Antiga)</option>
                                <option value="leads">Leads Comprados (Frio)</option>
                                <option value="simples">Lista Simples (Nome, Telefone)</option>
                            </select>
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label class="text-xs font-semibold text-apple-textMut uppercase tracking-wider pl-1">Classificar como</label>
                            <select id="colar-tipo" class="w-full bg-white border border-apple-border rounded-xl px-4 py-2.5 mt-1.5 text-sm outline-none transition-all cursor-pointer">
                                <option value="Normal">Normal</option>
                                <option value="VIP">VIP</option>
                            </select>
                        </div>
                    </div>
                    
                    <textarea id="texto-csv" placeholder="Cole os dados aqui..." class="w-full h-40 bg-white border border-apple-border rounded-xl p-4 text-sm font-mono outline-none focus:ring-2 focus:ring-brand-400 transition-all resize-none shadow-inner"></textarea>
                    
                    <button onclick="processarTextoColado()" class="w-full mt-4 bg-brand-600 hover:bg-brand-500 text-white font-bold py-3.5 rounded-xl transition-all shadow-sm flex justify-center items-center gap-2">
                        <i class="ph ph-check-circle text-lg"></i> Processar Dados Colados
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- Firebase Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDoDSwkJ-znIdsL3DpdYAiRqvl8wzEuqkA",
            authDomain: "relogiostore-3d7e7.firebaseapp.com",
            projectId: "relogiostore-3d7e7",
            storageBucket: "relogiostore-3d7e7.firebasestorage.app",
            messagingSenderId: "829089371669",
            appId: "1:829089371669:web:c828b7543e30ec32eea01c"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "relogiostore-3d7e7";

        // Global State
        let currentUser = null;
        let allLeads = [];
        let rotinaTasks = [];
        let currentView = 'dashboard';
        const hoje = new Date().toISOString().split('T')[0];

        // Global State - Cat√°logo
        let catalogProducts = [];
        let catalogFiltered = [];
        let catSearch = "";
        let hasCnpj = false;
        let isCatalogLoaded = false;
        let isGeneratingPdf = false;
        const API_CATALOG = "https://www.relogiostorevip.com.br/web_api";

        // --- SISTEMA DE TOASTS ---
        window.showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            let bgClass = "bg-apple-text";
            let icon = "ph-check-circle";
            
            if (type === 'error') { bgClass = "bg-red-500"; icon = "ph-warning-circle"; }
            if (type === 'info') { bgClass = "bg-brand-500"; icon = "ph-info"; }
            if (type === 'warning') { bgClass = "bg-amber-500"; icon = "ph-warning"; }

            toast.className = `${bgClass} text-white px-6 py-4 rounded-2xl shadow-apple flex items-center gap-3 min-w-[300px] toast-enter pointer-events-auto border border-white/10`;
            toast.innerHTML = `<i class="ph ${icon} text-xl flex-shrink-0"></i><span class="text-sm font-medium leading-snug">${message}</span>`;

            container.appendChild(toast);

            requestAnimationFrame(() => {
                toast.classList.remove('toast-enter');
                toast.classList.add('toast-enter-active');
            });

            setTimeout(() => {
                toast.classList.remove('toast-enter-active');
                toast.classList.add('toast-exit-active');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        };

        // --- REL√ìGIO CLOCK ---
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock-display').innerText = now.toLocaleTimeString('pt-PT', {hour: '2-digit', minute:'2-digit'});
        }, 1000);

        // --- AUTH ---
        window.fazerLogin = async () => {
            const e = document.getElementById('login-email').value, p = document.getElementById('login-password').value, err = document.getElementById('login-error');
            const btn = document.getElementById('btn-login');
            if(!e||!p) return err.innerText = "Por favor, preencha os dados.", err.classList.remove('hidden');
            
            btn.innerHTML = '<i class="ph ph-spinner-gap animate-spin text-lg inline-block"></i>';
            try { await signInWithEmailAndPassword(auth, e, p); } 
            catch (error) { err.innerText = "Credenciais inv√°lidas.", err.classList.remove('hidden'); btn.innerText = 'Iniciar Sess√£o'; }
        };
        window.fazerLogout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('loading-screen').classList.remove('hidden');
                setupListeners();
            } else {
                currentUser = null;
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('loading-screen').classList.add('hidden');
            }
        });

        // --- DATA LAYER ---
        function setupListeners() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'leads_v2'), (snapshot) => {
                allLeads = snapshot.docs.map(d => ({ dbId: d.id, ...d.data() }));
                allLeads = allLeads.map(lead => ({ ...lead, classe: classificarCliente(lead) }));
                
                document.getElementById('loading-screen').classList.add('hidden');
                renderNav();
                if (currentView !== 'catalogo') renderCurrentView();
            });

            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'checklists_v2', hoje), (docSnap) => {
                if(docSnap.exists() && docSnap.data().tasks) {
                    rotinaTasks = docSnap.data().tasks;
                } else {
                    rotinaTasks = [
                        { id: 't1', title: '07:40 - 08:45 | In√≠cio: WhatsApp (mensagens noite) e Insta', done: false, doneAt: null },
                        { id: 't2', title: '08:45 - 09:00 | ‚òï Pausa: Caf√© da Manh√£', done: false, doneAt: null },
                        { id: 't3', title: '09:00 - 11:00 | Vendas: Postar VIP e Ligar Leads Frios', done: false, doneAt: null },
                        { id: 't4', title: '11:00 - 13:20 | Site: Carrinhos e Campanhas', done: false, doneAt: null },
                        { id: 't5', title: '13:20 - 14:20 | üçΩÔ∏è Pausa: Almo√ßo', done: false, doneAt: null },
                        { id: 't6', title: '14:20 - 16:30 | Follow-up: P√≥s-Venda e Atendimento', done: false, doneAt: null },
                        { id: 't7', title: '16:30 - 16:45 | ‚òï Pausa: Caf√© da Tarde', done: false, doneAt: null },
                        { id: 't8', title: '16:45 - 17:00 | Fecho: Atualizar Etiquetas (CRM)', done: false, doneAt: null }
                    ];
                }
                if(currentView === 'dashboard') renderDashboard(document.getElementById('app-content'));
            });
        }

        function classificarCliente(lead) {
            const hojeData = new Date(hoje);
            const dataCadastro = new Date(lead.dataEntrada || hoje);
            const dataCompra = lead.dataUltimaCompra ? new Date(lead.dataUltimaCompra) : null;
            const diffCadastro = Math.floor((hojeData - dataCadastro) / (1000 * 60 * 60 * 24));
            const diffCompra = dataCompra ? Math.floor((hojeData - dataCompra) / (1000 * 60 * 60 * 24)) : Infinity;

            if (lead.origem === 'Carrinho Abandonado') return 'Carrinho';
            if (lead.origem === 'Comprado') return 'Lead Frio';
            if (dataCompra && diffCompra <= 7) return 'P√≥s-Venda';
            if (dataCompra && diffCompra <= 30) return 'Ativo';
            if (dataCompra && diffCompra > 30 && diffCompra <= 90) return 'Risco Inatividade';
            if (dataCompra && diffCompra > 90) return 'Inativo';
            if (diffCadastro <= 7 && !dataCompra) return 'Novo Lead';
            
            return 'Prospect';
        }

        // --- NAVIGATION ---
        const views = [
            { id: 'dashboard', icon: 'ph-squares-four', label: 'Dashboard' },
            { id: 'catalogo', icon: 'ph-package', label: 'Cat√°logo & Estoque' },
            { id: 'carrinhos', icon: 'ph-shopping-cart', label: 'Carrinhos', badge: () => allLeads.filter(l => l.classe==='Carrinho' && l.status!=='Convertido').length },
            { id: 'comprados', icon: 'ph-users', label: 'Leads Comprados' },
            { id: 'base', icon: 'ph-database', label: 'Base de Clientes' }
        ];

        window.navigate = (viewId) => { 
            currentView = viewId; 
            renderNav(); 
            
            if(currentView === 'catalogo') {
                document.getElementById('global-actions').style.display = 'none';
            } else {
                document.getElementById('global-actions').style.display = 'flex';
            }

            renderCurrentView(); 
        };

        function renderNav() {
            const nav = document.getElementById('main-nav');
            nav.innerHTML = views.map(v => {
                const isActive = currentView === v.id;
                const badgeStr = v.badge && v.badge() > 0 ? `<span class="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full ml-auto shadow-sm">${v.badge()}</span>` : '';
                return `
                <button onclick="navigate('${v.id}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-2xl text-sm font-semibold transition-all duration-300 ${isActive ? 'bg-white text-apple-text shadow-sm border border-apple-border/50' : 'text-apple-textMut hover:bg-black/5 hover:text-apple-text'}">
                    <i class="ph ${v.icon} text-xl ${isActive ? 'text-brand-500' : ''}"></i> ${v.label} ${badgeStr}
                </button>
                `;
            }).join('');
        }

        function renderCurrentView() {
            const c = document.getElementById('app-content');
            if(currentView === 'dashboard') renderDashboard(c);
            if(currentView === 'catalogo') renderCatalogo(c);
            if(currentView === 'carrinhos') renderCarrinhos(c);
            if(currentView === 'comprados') renderComprados(c);
            if(currentView === 'base') renderBase(c);
        }

        // --- VIEWS RENDERERS ---

        function renderDashboard(c) {
            document.getElementById('page-title').innerText = "Dashboard Inteligente";
            const stats = {
                normal: {
                    novos: allLeads.filter(l => l.tipoCliente !== 'VIP' && l.classe === 'Novo Lead').length,
                    posvenda: allLeads.filter(l => l.tipoCliente !== 'VIP' && l.classe === 'P√≥s-Venda').length,
                    ativos: allLeads.filter(l => l.tipoCliente !== 'VIP' && l.classe === 'Ativo').length,
                    risco: allLeads.filter(l => l.tipoCliente !== 'VIP' && l.classe === 'Risco Inatividade').length,
                    inativos: allLeads.filter(l => l.tipoCliente !== 'VIP' && l.classe === 'Inativo').length,
                },
                vip: {
                    novos: allLeads.filter(l => l.tipoCliente === 'VIP' && l.classe === 'Novo Lead').length,
                    posvenda: allLeads.filter(l => l.tipoCliente === 'VIP' && l.classe === 'P√≥s-Venda').length,
                    ativos: allLeads.filter(l => l.tipoCliente === 'VIP' && l.classe === 'Ativo').length,
                    risco: allLeads.filter(l => l.tipoCliente === 'VIP' && l.classe === 'Risco Inatividade').length,
                    inativos: allLeads.filter(l => l.tipoCliente === 'VIP' && l.classe === 'Inativo').length,
                }
            };

            const CardKPI = (title, valNormal, valVip, icon, colorClass) => `
                <div class="bg-apple-bg/50 p-6 rounded-[1.5rem] border border-apple-border/30 hover:shadow-apple-hover transition-all duration-300 flex flex-col justify-between group">
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-xs font-bold text-apple-textMut uppercase tracking-wider">${title}</p>
                        <div class="w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i class="ph ${icon} ${colorClass} text-lg"></i>
                        </div>
                    </div>
                    <div class="flex gap-6 items-end">
                        <div><p class="text-3xl font-bold text-apple-text tracking-tight">${valNormal}</p><p class="text-[10px] text-apple-textMut uppercase font-semibold mt-1">Normal</p></div>
                        <div class="border-l border-apple-border/50 pl-6"><p class="text-3xl font-bold text-vip-600 tracking-tight">${valVip}</p><p class="text-[10px] text-vip-400 uppercase font-semibold mt-1">VIP</p></div>
                    </div>
                </div>`;

            c.innerHTML = `
                <div class="slide-up space-y-8 max-w-[1400px] mx-auto pb-10">
                    
                    <!-- Links R√°pidos -->
                    <div>
                        <h3 class="text-lg font-bold text-apple-text mb-4">Acessos R√°pidos</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <a href="https://erp.grupotuguir.com.br/login.php" target="_blank" class="group bg-gradient-to-br from-slate-800 to-slate-900 p-5 rounded-[1.5rem] text-white flex items-center gap-4 hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                                <div class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center backdrop-blur-md group-hover:bg-white/20 transition-colors"><i class="ph ph-package text-2xl"></i></div>
                                <div><h4 class="font-bold">ERP Tuguir</h4><p class="text-xs text-white/60 font-medium">Verificar Estoque & Produtos</p></div>
                                <i class="ph ph-arrow-up-right ml-auto opacity-50 group-hover:opacity-100 transition-opacity"></i>
                            </a>
                            <a href="https://www.relogiostore.com.br/" target="_blank" class="group bg-gradient-to-br from-brand-500 to-brand-600 p-5 rounded-[1.5rem] text-white flex items-center gap-4 hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                                <div class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center backdrop-blur-md group-hover:bg-white/20 transition-colors"><i class="ph ph-storefront text-2xl"></i></div>
                                <div><h4 class="font-bold">Loja Aberta</h4><p class="text-xs text-white/60 font-medium">Rel√≥gio Store Normal</p></div>
                                <i class="ph ph-arrow-up-right ml-auto opacity-50 group-hover:opacity-100 transition-opacity"></i>
                            </a>
                            <a href="https://www.relogiostorevip.com.br/" target="_blank" class="group bg-gradient-to-br from-vip-600 to-vip-800 p-5 rounded-[1.5rem] text-white flex items-center gap-4 hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                                <div class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center backdrop-blur-md group-hover:bg-white/20 transition-colors"><i class="ph ph-crown text-2xl"></i></div>
                                <div><h4 class="font-bold">Loja VIP</h4><p class="text-xs text-white/60 font-medium">Acesso Fechado</p></div>
                                <i class="ph ph-arrow-up-right ml-auto opacity-50 group-hover:opacity-100 transition-opacity"></i>
                            </a>
                        </div>
                    </div>

                    <!-- Rotina & KPIs Lado a Lado -->
                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                        
                        <!-- Coluna Esquerda: Checklist & Calend√°rio -->
                        <div class="xl:col-span-1 flex flex-col gap-6">
                            
                            <!-- Rotina Di√°ria (Checklist) -->
                            <div class="bg-apple-bg/40 border border-apple-border/40 rounded-[2rem] overflow-hidden shadow-sm flex flex-col max-h-[450px]">
                                <div class="p-6 border-b border-apple-border/30 flex items-center gap-4 bg-white/50 backdrop-blur-md">
                                    <div class="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center text-brand-500 shrink-0">
                                        <i class="ph ph-list-checks text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg text-apple-text tracking-tight">Checklist Di√°rio</h3>
                                        <p class="text-[11px] font-medium text-apple-textMut mt-0.5 uppercase tracking-wider">Das 07:40 √†s 17:00</p>
                                    </div>
                                </div>
                                <div class="p-3 flex-1 overflow-y-auto space-y-1.5 bg-white">
                                    ${rotinaTasks.map(t => {
                                        const parts = t.title.split('|');
                                        const timeHTML = parts.length > 1 ? `<span class="font-bold text-brand-600 mr-1">${parts[0].trim()}</span> <span class="text-apple-border mx-0.5">|</span> ` : '';
                                        const titleHTML = parts.length > 1 ? parts[1].trim() : t.title;
                                        
                                        return `
                                        <div class="group flex items-center justify-between p-3 bg-apple-bg/30 rounded-xl hover:bg-apple-bg transition-colors border border-transparent hover:border-apple-border/30 cursor-pointer" onclick="document.getElementById('${t.id}').click()">
                                            <label class="flex items-center gap-3 cursor-pointer flex-1 min-w-0" onclick="event.stopPropagation()">
                                                <input type="checkbox" id="${t.id}" class="apple-checkbox shrink-0" ${t.done ? 'checked' : ''} onchange="toggleTaskDone('${t.id}', this.checked)">
                                                <span class="text-xs truncate transition-colors duration-300 ${t.done ? 'text-apple-textMut line-through' : 'text-apple-text font-medium'}">
                                                    ${timeHTML} ${titleHTML}
                                                </span>
                                            </label>
                                            ${t.done && t.doneAt ? `<span class="shrink-0 bg-brand-50 text-brand-700 text-[10px] font-bold px-2 py-1 rounded-full border border-brand-100 fade-in flex items-center gap-1">${t.doneAt}</span>` : ''}
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>

                            <!-- Calend√°rio Sazonal -->
                            <div class="bg-apple-bg/40 border border-apple-border/40 rounded-[2rem] p-6 shadow-sm">
                                <div class="flex items-center gap-4 mb-5">
                                    <div class="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center text-orange-500 shrink-0">
                                        <i class="ph ph-calendar-star text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg text-apple-text tracking-tight">Datas Sazonais</h3>
                                        <p class="text-[11px] font-medium text-apple-textMut mt-0.5 uppercase tracking-wider">Aten√ß√£o √†s Vendas</p>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex items-center gap-3 p-3 bg-white rounded-xl shadow-[0_2px_8px_rgba(0,0,0,0.02)] border border-apple-border/20">
                                        <div class="bg-emerald-50 text-emerald-600 font-bold text-xs px-2 py-1.5 rounded-lg shrink-0 w-14 text-center">05 Mar</div>
                                        <p class="text-sm font-semibold text-apple-text">Pagamento (5¬∫ Dia √ötil)</p>
                                    </div>
                                    <div class="flex items-center gap-3 p-3 bg-white rounded-xl shadow-[0_2px_8px_rgba(0,0,0,0.02)] border border-apple-border/20">
                                        <div class="bg-purple-50 text-purple-600 font-bold text-xs px-2 py-1.5 rounded-lg shrink-0 w-14 text-center">08 Mar</div>
                                        <p class="text-sm font-semibold text-apple-text">Dia da Mulher</p>
                                    </div>
                                    <div class="flex items-center gap-3 p-3 bg-white rounded-xl shadow-[0_2px_8px_rgba(0,0,0,0.02)] border border-apple-border/20">
                                        <div class="bg-blue-50 text-blue-600 font-bold text-xs px-2 py-1.5 rounded-lg shrink-0 w-14 text-center">15 Mar</div>
                                        <p class="text-sm font-semibold text-apple-text">Dia do Consumidor</p>
                                    </div>
                                    <div class="flex items-center gap-3 p-3 bg-white rounded-xl shadow-[0_2px_8px_rgba(0,0,0,0.02)] border border-apple-border/20">
                                        <div class="bg-pink-50 text-pink-600 font-bold text-xs px-2 py-1.5 rounded-lg shrink-0 w-14 text-center">10 Mai</div>
                                        <p class="text-sm font-semibold text-apple-text">Dia das M√£es</p>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- KPIs -->
                        <div class="xl:col-span-2 space-y-8">
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                ${CardKPI('P√≥s-Venda', stats.normal.posvenda, stats.vip.posvenda, 'ph-gift', 'text-brand-500')}
                                ${CardKPI('Ativos (<30d)', stats.normal.ativos, stats.vip.ativos, 'ph-fire', 'text-rose-500')}
                                ${CardKPI('Risco (>30d)', stats.normal.risco, stats.vip.risco, 'ph-warning-circle', 'text-orange-500')}
                                ${CardKPI('Inativos (>90d)', stats.normal.inativos, stats.vip.inativos, 'ph-snowflake', 'text-blue-400')}
                            </div>
                            
                            <!-- Gr√°fico -->
                            <div class="bg-apple-bg/30 p-8 rounded-[2rem] border border-apple-border/30 shadow-sm">
                                <h3 class="font-bold text-apple-text mb-6 flex items-center gap-2 text-lg"><i class="ph ph-map-pin text-brand-500"></i> Distribui√ß√£o por Estado</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-x-8 gap-y-6" id="chart-estados">
                                    <!-- JS will populate -->
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            `;

            // State chart logic
            const ufs = {};
            allLeads.forEach(l => { if(l.uf) { ufs[l.uf] = (ufs[l.uf]||0)+1; }});
            const sortedUfs = Object.entries(ufs).sort((a,b)=>b[1]-a[1]).slice(0,8);
            const maxVal = sortedUfs[0]?.[1] || 1;
            
            document.getElementById('chart-estados').innerHTML = sortedUfs.map(([uf, count]) => `
                <div class="group">
                    <div class="flex justify-between text-sm mb-2"><span class="font-bold text-apple-text">${uf}</span><span class="text-apple-textMut font-medium">${count}</span></div>
                    <div class="w-full bg-apple-border/40 rounded-full h-2.5 overflow-hidden"><div class="bg-gradient-to-r from-brand-400 to-brand-600 h-full rounded-full transition-all duration-1000 ease-out group-hover:opacity-80" style="width: ${(count/maxVal)*100}%"></div></div>
                </div>
            `).join('') || '<p class="text-sm text-apple-textMut col-span-4 py-4 font-medium">Sem dados regionais suficientes recolhidos no sistema.</p>';
        }

        window.toggleTaskDone = async (taskId, isDone) => {
            const index = rotinaTasks.findIndex(t => t.id === taskId);
            if (index > -1) {
                rotinaTasks[index].done = isDone;
                rotinaTasks[index].doneAt = isDone ? new Date().toLocaleTimeString('pt-PT', {hour: '2-digit', minute:'2-digit'}) : null;
                
                if(currentView === 'dashboard') renderDashboard(document.getElementById('app-content'));
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'checklists_v2', hoje), { tasks: rotinaTasks }, { merge: true });
            }
        };

        // --- CATALOGO VIEW ---
        window.toggleCnpj = () => {
            hasCnpj = document.getElementById('cat-cnpj').checked;
            filterCatalog();
        };

        window.filterCatalog = () => {
            catSearch = document.getElementById('cat-search') ? document.getElementById('cat-search').value.toLowerCase() : "";
            catalogFiltered = catalogProducts.filter(p => {
                const matchSearch = catSearch ? (p.name.toLowerCase().includes(catSearch) || (p.reference||"").toLowerCase().includes(catSearch)) : true;
                return matchSearch;
            });
            renderCatalogGrid();
        };

        function renderCatalogo(c) {
            document.getElementById('page-title').innerText = "Cat√°logo & Estoque";

            c.innerHTML = `
                <div class="slide-up max-w-[1400px] mx-auto bg-apple-bg/30 border border-apple-border/30 rounded-[2rem] shadow-sm flex flex-col h-[calc(100vh-8rem)] overflow-hidden">
                    <div class="p-6 border-b border-apple-border/30 flex flex-col md:flex-row gap-4 bg-white/50 backdrop-blur-md shrink-0 items-center justify-between">
                        
                        <div class="flex flex-col md:flex-row items-center gap-4 flex-1 w-full">
                            <div class="relative flex-1 max-w-md w-full">
                                <i class="ph ph-magnifying-glass absolute left-4 top-3 text-apple-textMut text-lg"></i>
                                <input type="text" id="cat-search" onkeyup="filterCatalog()" placeholder="Buscar produto ou refer√™ncia..." class="w-full bg-white border border-apple-border rounded-full pl-11 pr-4 py-2.5 text-sm font-medium outline-none focus:ring-2 focus:ring-brand-400 transition-all shadow-sm">
                            </div>
                            
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-5 py-2.5 rounded-full border border-apple-border shadow-sm hover:bg-gray-50 transition-colors">
                                <input type="checkbox" id="cat-cnpj" onchange="toggleCnpj()" class="apple-checkbox w-4 h-4" ${hasCnpj ? 'checked' : ''}>
                                <span class="text-sm font-bold text-apple-text">Cliente possui CNPJ (Desbloqueia Tuguir)</span>
                            </label>
                        </div>

                        <button onclick="window.generateCatalogPdf()" id="btn-cat-pdf" class="w-full md:w-auto bg-brand-600 hover:bg-brand-500 text-white px-6 py-2.5 rounded-full text-sm font-bold flex items-center justify-center gap-2 transition-all shadow-sm hover:shadow-md">
                            <i class="ph ph-file-pdf text-lg"></i> Baixar PDF (S/ Pre√ßo)
                        </button>
                    </div>

                    <div class="overflow-y-auto flex-1 p-6 bg-white" id="catalog-grid">
                        ${!isCatalogLoaded ? `<div class="flex flex-col items-center justify-center h-full text-apple-textMut"><i class="ph ph-circle-notch animate-spin-slow text-4xl text-brand-500 mb-4"></i><p class="font-semibold" id="loading-text">A carregar produtos da loja...</p></div>` : ''}
                    </div>
                </div>
            `;

            if (!isCatalogLoaded) fetchCatalog();
            else renderCatalogGrid();
        }

        async function fetchCatalog() {
            try {
                let currentPage = 1;
                let hasMore = true;
                let limit = 50;
                let allFetched = [];

                while(hasMore) {
                    const loadingText = document.getElementById('loading-text');
                    if(loadingText) loadingText.innerText = `A transferir cat√°logo... (${allFetched.length} produtos)`;

                    const response = await fetch(`${API_CATALOG}/products?limit=${limit}&page=${currentPage}`);
                    if(!response.ok) throw new Error("Erro API");
                    
                    const data = await response.json();
                    
                    if(data.Products && Array.isArray(data.Products)) {
                        const pageProducts = data.Products.map(item => item.Product);
                        allFetched = [...allFetched, ...pageProducts];
                        
                        const totalRecords = parseInt(data.paging?.total || 0);
                        
                        if(pageProducts.length < limit || (totalRecords > 0 && allFetched.length >= totalRecords)) {
                            hasMore = false;
                        } else {
                            currentPage++;
                        }
                    } else {
                        hasMore = false;
                    }
                }
                catalogProducts = allFetched;
            } catch (e) {
                console.error("Erro ao puxar dados da API:", e);
                // Mock se API falhar
                const brandsList = ["Skmei", "Tuguir", "Onix", "Weide"];
                catalogProducts = [];
                for(let i=1; i<=60; i++) {
                    const b = brandsList[i % brandsList.length];
                    const outStock = i % 8 === 0; 
                    catalogProducts.push({
                        id: i, name: `Rel√≥gio ${b} Luxo Executivo ${i}`, price: (80 + i).toFixed(2),
                        reference: `${b.substring(0,3).toUpperCase()}-${i}`, brand: b,
                        ProductImage: [{ http: `https://via.placeholder.com/300x300?text=${b}` }],
                        stock: outStock ? "0" : "15", available: outStock ? "0" : "1"
                    });
                }
            } finally {
                isCatalogLoaded = true;
                filterCatalog();
            }
        }

        function renderCatalogGrid() {
            const grid = document.getElementById('catalog-grid');
            if(!grid) return;

            if (catalogFiltered.length === 0) {
                grid.innerHTML = `<div class="flex flex-col items-center justify-center py-20 text-apple-textMut"><i class="ph ph-package-x text-5xl mb-3 opacity-50"></i><p class="font-semibold">Nenhum produto encontrado.</p></div>`;
                return;
            }

            let html = `<div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">`;
            
            catalogFiltered.forEach(p => {
                const isTuguir = (p.brand || "").toLowerCase() === 'tuguir';
                const isLocked = isTuguir && !hasCnpj;
                
                const isAvailable = p.available == 1;
                const stockQty = Number(p.stock || 0);
                
                let badgeHTML = '';
                if (isAvailable) {
                    if (stockQty <= 0) {
                        badgeHTML = `<span class="absolute top-2 right-2 bg-emerald-500 text-white border border-emerald-600 text-[9px] font-bold px-2 py-0.5 rounded-full z-10 shadow-sm">PRONTA ENTREGA</span>`;
                    } else {
                        badgeHTML = `<span class="absolute top-2 right-2 bg-emerald-50 text-emerald-700 border border-emerald-200 text-[9px] font-bold px-2 py-0.5 rounded-full z-10">EST: ${stockQty}</span>`;
                    }
                } else {
                    badgeHTML = `<span class="absolute top-2 right-2 bg-apple-bg text-apple-textMut border border-apple-border/50 text-[9px] font-bold px-2 py-0.5 rounded-full z-10">ESGOTADO</span>`;
                }

                let imgUrl = p.ProductImage?.[0]?.https || p.ProductImage?.[0]?.http || "https://via.placeholder.com/300?text=Sem+Foto";
                imgUrl = imgUrl.replace('http://', 'https://');

                html += `
                    <div class="group bg-apple-bg/40 rounded-2xl border border-apple-border/40 overflow-hidden flex flex-col hover:shadow-apple-hover transition-all duration-300 relative">
                        <div class="aspect-square bg-white relative overflow-hidden p-4 flex items-center justify-center">
                            <img src="${imgUrl}" class="w-full h-full object-contain transition-transform duration-500 ${isLocked || !isAvailable ? 'blur-[3px] grayscale scale-110' : 'group-hover:scale-105'}" loading="lazy">
                            
                            ${badgeHTML}
                            
                            ${isLocked ? `
                                <div class="absolute inset-0 bg-white/30 backdrop-blur-sm flex items-center justify-center z-10">
                                    <span class="bg-black/80 text-white text-[10px] font-bold px-3 py-1.5 rounded-full flex items-center gap-1.5"><i class="ph-fill ph-lock-key"></i> Exclusivo CNPJ</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="p-3 flex-1 flex flex-col bg-white">
                            <p class="text-[9px] text-apple-textMut font-bold uppercase tracking-wider mb-0.5">REF: ${p.reference || '-'}</p>
                            <h3 class="text-xs font-semibold text-apple-text leading-tight line-clamp-2 mb-2 ${isLocked ? 'blur-[4px] select-none' : ''}">${p.name}</h3>
                            <div class="mt-auto pt-2 border-t border-apple-bg flex justify-between items-end">
                                <span class="text-[9px] font-bold px-1.5 py-0.5 bg-apple-bg rounded text-apple-textMut">${p.brand || 'Marca'}</span>
                                <span class="text-sm font-bold text-brand-600">${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(p.price || 0)}</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `</div>`;
            grid.innerHTML = html;
        }

        window.generateCatalogPdf = async () => {
            if(isGeneratingPdf) return;
            if(!window.jspdf) { showToast("Biblioteca PDF n√£o carregada.", "error"); return; }

            const items = catalogFiltered.filter(p => p.available == 1);
            
            if(items.length === 0) {
                showToast("N√£o h√° produtos em estoque com o filtro atual.", "warning"); return;
            }

            const btn = document.getElementById('btn-cat-pdf');
            btn.innerHTML = `<i class="ph ph-spinner-gap animate-spin text-lg"></i> Gerando PDF...`;
            isGeneratingPdf = true;

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = doc.internal.pageSize.getWidth(); 
                const pageHeight = doc.internal.pageSize.getHeight(); 
                
                const margin = 10;
                const cols = 4; // 4 colunas no PDF
                const gap = 4;
                const cardWidth = (pageWidth - (margin * 2) - (gap * (cols - 1))) / cols; 
                const cardHeight = 65; 
                
                let x = margin;
                let y = 35; 
                let col = 0;

                // Header PDF
                doc.setFillColor(29, 29, 31); // Apple text color
                doc.rect(0, 0, pageWidth, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont("helvetica", "bold");
                doc.setFontSize(16);
                doc.text("CAT√ÅLOGO DE PRODUTOS", 15, 12); 
                doc.setFont("helvetica", "normal");
                doc.setFontSize(9);
                doc.text("Apenas Itens Dispon√≠veis em Estoque (Sem Pre√ßos)", 15, 18);
                doc.setFontSize(8);
                doc.text(new Date().toLocaleDateString('pt-BR'), pageWidth - 15, 15, {align: 'right'});

                for(let i=0; i<items.length; i++) {
                    const p = items[i];
                    
                    if (y + cardHeight > pageHeight - 10) {
                        doc.addPage();
                        y = 15; x = margin; col = 0;
                    }

                    const isTuguir = (p.brand || "").toLowerCase() === 'tuguir';
                    const isLocked = isTuguir && !hasCnpj;

                    doc.setDrawColor(230, 230, 235);
                    doc.setFillColor(255, 255, 255);
                    doc.roundedRect(x, y, cardWidth, cardHeight, 2, 2, 'FD');

                    const imgSize = cardWidth - 6;
                    const imgX = x + 3;
                    const imgY = y + 3;

                    if (isLocked) {
                        // Bloqueado Tuguir - Placeholder
                        doc.setFillColor(245, 245, 247);
                        doc.rect(imgX, imgY, imgSize, imgSize, 'F');
                        doc.setTextColor(150, 150, 155);
                        doc.setFont("helvetica", "bold");
                        doc.setFontSize(7);
                        doc.text("EXCLUSIVO", imgX + imgSize/2, imgY + imgSize/2 - 2, { align: 'center' });
                        doc.text("CNPJ", imgX + imgSize/2, imgY + imgSize/2 + 3, { align: 'center' });
                    } else {
                        // Imagem real
                        let imgUrl = p.ProductImage?.[0]?.https || p.ProductImage?.[0]?.http;
                        if(imgUrl) {
                            imgUrl = imgUrl.replace('http://', 'https://');
                            const imgData = await getBase64Image(imgUrl);
                            if(imgData) {
                                try {
                                    doc.addImage(imgData, 'JPEG', imgX, imgY, imgSize, imgSize);
                                } catch(e){}
                            }
                        }
                    }

                    const textY = imgY + imgSize + 4;
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(6);
                    doc.setTextColor(134, 134, 139); // TextMut
                    doc.text(isLocked ? "MARCA RESERVADA" : (p.brand || "MARCA").toUpperCase(), x + 3, textY);
                    
                    doc.text(`REF: ${p.reference || '-'}`, x + cardWidth - 3, textY, {align: 'right'});

                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(7);
                    doc.setTextColor(29, 29, 31);
                    
                    const nameTxt = isLocked ? "Produto indispon√≠vel para o seu tipo de cadastro." : (p.name || "");
                    const splitTitle = doc.splitTextToSize(nameTxt, cardWidth - 6);
                    doc.text(splitTitle.slice(0, 2), x + 3, textY + 4);

                    col++;
                    if (col >= cols) { col = 0; x = margin; y += cardHeight + gap; } 
                    else { x += cardWidth + gap; }
                }

                doc.save(`Catalogo_Estoque_${new Date().getTime()}.pdf`);
                showToast("PDF gerado e descarregado com sucesso!");
            } catch (error) {
                console.error(error);
                showToast("Erro ao gerar PDF.", "error");
            } finally {
                isGeneratingPdf = false;
                btn.innerHTML = `<i class="ph ph-file-pdf text-lg"></i> Baixar PDF (S/ Pre√ßo)`;
            }
        }

        async function getBase64Image(url) {
            const proxies = ['https://corsproxy.io/?', 'https://api.allorigins.win/raw?url='];
            for (let prefix of proxies) {
                try {
                    const controller = new AbortController();
                    const id = setTimeout(() => controller.abort(), 4000);
                    const res = await fetch(prefix + url, { signal: controller.signal });
                    clearTimeout(id);
                    if(!res.ok) continue;
                    const blob = await res.blob();
                    return await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.readAsDataURL(blob);
                    });
                } catch(e) { continue; }
            }
            return null;
        }

        // --- CARRINHOS, COMPRADOS E BASE LOGIC ---
        function renderCarrinhos(c) {
            document.getElementById('page-title').innerText = "Carrinhos Abandonados";
            const carrinhos = allLeads.filter(l => l.classe === 'Carrinho');
            
            c.innerHTML = `
                <div class="slide-up max-w-[1400px] mx-auto space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${carrinhos.map(lead => `
                            <div class="bg-apple-bg/40 border ${lead.proxRetorno <= hoje ? 'border-red-300/50 shadow-[0_0_15px_rgba(239,68,68,0.1)]' : 'border-apple-border/40'} rounded-[1.5rem] p-6 shadow-sm relative overflow-hidden flex flex-col group hover:shadow-apple-hover transition-all duration-300 hover:-translate-y-1">
                                ${lead.proxRetorno <= hoje ? '<div class="absolute top-0 left-0 w-1.5 h-full bg-red-500"></div>' : ''}
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="font-bold text-lg text-apple-text tracking-tight">${lead.nome}</h3>
                                        <p class="text-xs font-semibold text-apple-textMut mt-0.5">${lead.telefone}</p>
                                    </div>
                                    <span class="text-[10px] font-bold uppercase px-3 py-1.5 rounded-full bg-white text-apple-text border border-apple-border shadow-sm">Tentativa ${lead.tentativas || 0}</span>
                                </div>
                                <div class="mt-auto pt-4 space-y-4">
                                    <div class="bg-white rounded-xl p-3 border border-apple-border/30 flex items-center justify-between">
                                        <span class="text-xs font-semibold text-apple-textMut">Pr√≥x. Contato:</span>
                                        <span class="text-sm font-bold ${lead.proxRetorno <= hoje ? 'text-red-500' : 'text-apple-text'}">${formatDate(lead.proxRetorno) || 'Hoje'}</span>
                                    </div>
                                    <button onclick="avancarCarrinho('${lead.dbId}')" class="w-full bg-brand-50 text-brand-700 border border-brand-200 py-3 rounded-xl text-sm font-bold hover:bg-brand-500 hover:text-white hover:border-brand-500 transition-all flex justify-center items-center gap-2">
                                        <i class="ph ph-whatsapp-logo text-lg"></i> Enviar Mensagem
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                        ${carrinhos.length === 0 ? '<div class="col-span-full bg-apple-bg/30 border border-apple-border/30 rounded-[2rem] p-16 text-center"><div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm"><i class="ph ph-shopping-cart-simple text-2xl text-apple-textMut"></i></div><p class="font-semibold text-apple-text">Tudo limpo!</p><p class="text-sm text-apple-textMut mt-1">Nenhum carrinho pendente no momento.</p></div>' : ''}
                    </div>
                </div>
            `;
        }

        function renderComprados(c) {
            document.getElementById('page-title').innerText = "Leads Comprados (Frio)";
            const comprados = allLeads.filter(l => l.classe === 'Lead Frio');
            
            c.innerHTML = `
                <div class="slide-up max-w-[1400px] mx-auto bg-apple-bg/30 border border-apple-border/30 rounded-[2rem] shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-apple-border/30 bg-white/50 backdrop-blur-md flex justify-between items-center">
                        <span class="text-sm font-bold text-apple-text">${comprados.length} Leads Importados</span>
                    </div>
                    <div class="overflow-x-auto p-2">
                        <table class="w-full text-left text-sm border-separate border-spacing-y-2">
                            <thead class="text-apple-textMut text-xs uppercase tracking-wider font-semibold px-4">
                                <tr><th class="py-2 px-6">Lead</th><th class="py-2 px-4">Telefone</th><th class="py-2 px-4">Tag Atual</th><th class="py-2 px-4">Pr√≥x. A√ß√£o</th><th class="py-2 px-6 text-right">A√ß√£o</th></tr>
                            </thead>
                            <tbody>
                                ${comprados.map(lead => `
                                    <tr class="bg-white shadow-[0_2px_8px_rgba(0,0,0,0.02)] rounded-2xl transition-all duration-300 hover:shadow-md group">
                                        <td class="py-4 px-6 font-bold text-apple-text rounded-l-2xl">${lead.nome}</td>
                                        <td class="py-4 px-4 font-medium text-apple-textMut">${lead.telefone}</td>
                                        <td class="py-4 px-4"><span class="px-3 py-1 bg-apple-bg border border-apple-border/50 text-apple-text rounded-full text-xs font-bold shadow-sm">${lead.tag || 'Novo'}</span></td>
                                        <td class="py-4 px-4 text-xs font-semibold text-apple-textMut">${formatDate(lead.proxRetorno) || '-'}</td>
                                        <td class="py-4 px-6 text-right rounded-r-2xl">
                                            <select onchange="atualizarTag('${lead.dbId}', this.value)" class="text-xs border border-apple-border rounded-full px-3 py-1.5 outline-none bg-apple-bg font-semibold cursor-pointer hover:bg-gray-200 transition-colors appearance-none">
                                                <option value="">Alterar Tag...</option>
                                                <option value="Tentativa 1">Tentativa 1</option>
                                                <option value="Tentativa 2">Tentativa 2</option>
                                                <option value="Sem Resposta">Sem Resposta</option>
                                                <option value="Interessado">Interessado</option>
                                                <option value="Convertido">Convertido!</option>
                                            </select>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderBase(c) {
            document.getElementById('page-title').innerText = "Base de Clientes";
            const base = allLeads.filter(l => l.classe !== 'Carrinho' && l.classe !== 'Lead Frio');
            
            c.innerHTML = `
                <div class="slide-up max-w-[1400px] mx-auto bg-apple-bg/30 border border-apple-border/30 rounded-[2rem] shadow-sm flex flex-col h-[calc(100vh-10rem)] overflow-hidden">
                    <div class="p-6 border-b border-apple-border/30 flex gap-4 bg-white/50 backdrop-blur-md shrink-0">
                        <div class="relative flex-1 max-w-sm">
                            <i class="ph ph-magnifying-glass absolute left-4 top-3 text-apple-textMut text-lg"></i>
                            <input type="text" id="filtro-base" onkeyup="filtrarBase()" placeholder="Procurar clientes..." class="w-full bg-white border border-apple-border rounded-full pl-11 pr-4 py-2.5 text-sm font-medium outline-none focus:ring-2 focus:ring-brand-400 transition-all shadow-sm">
                        </div>
                        <select id="filtro-tipo" onchange="filtrarBase()" class="bg-white border border-apple-border rounded-full px-5 py-2.5 text-sm font-semibold outline-none cursor-pointer hover:bg-gray-50 transition-colors shadow-sm appearance-none">
                            <option value="">Todos (Normal & VIP)</option><option value="Normal">Normal</option><option value="VIP">VIP</option>
                        </select>
                    </div>
                    <div class="overflow-y-auto flex-1 p-2">
                        <table class="w-full text-left text-sm border-separate border-spacing-y-2">
                            <thead class="text-apple-textMut text-xs uppercase tracking-wider font-semibold sticky top-0 bg-apple-bg/90 backdrop-blur-md z-10">
                                <tr>
                                    <th class="py-3 px-6">Cliente</th><th class="py-3 px-4">Telefone</th>
                                    <th class="py-3 px-4">Categoria</th><th class="py-3 px-4">Status</th>
                                    <th class="py-3 px-4">√öltima Compra</th><th class="py-3 px-6 text-right">A√ß√£o R√°pida</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${base.map(lead => `
                                    <tr class="bg-white shadow-[0_2px_8px_rgba(0,0,0,0.02)] rounded-2xl transition-all duration-300 hover:shadow-md group row-base" data-nome="${lead.nome.toLowerCase()}" data-tel="${lead.telefone}" data-tipo="${lead.tipoCliente||'Normal'}">
                                        <td class="py-4 px-6 font-bold text-apple-text rounded-l-2xl flex items-center gap-2">
                                            ${lead.nome} ${lead.tipoCliente==='VIP'?'<i class="ph-fill ph-star text-vip-500" title="VIP"></i>':''}
                                        </td>
                                        <td class="py-4 px-4 font-medium text-apple-textMut">${lead.telefone}</td>
                                        <td class="py-4 px-4"><span class="text-[10px] font-bold uppercase tracking-wider px-3 py-1 rounded-full ${lead.tipoCliente==='VIP'?'bg-vip-50 text-vip-700 border border-vip-200':'bg-apple-bg text-apple-text border border-apple-border'} shadow-sm">${lead.tipoCliente||'Normal'}</span></td>
                                        <td class="py-4 px-4 text-xs font-bold ${getClasseColor(lead.classe)}">${lead.classe}</td>
                                        <td class="py-4 px-4 text-xs font-semibold text-apple-textMut">${formatDate(lead.dataUltimaCompra) || 'Nenhuma'}</td>
                                        <td class="py-4 px-6 text-right rounded-r-2xl">
                                            <button onclick="registarCompra('${lead.dbId}')" class="text-xs bg-white text-brand-600 hover:bg-brand-500 hover:text-white px-4 py-2 rounded-full font-bold border border-brand-200 transition-all shadow-sm">Nova Compra</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // --- BUSINESS ACTIONS ---
        window.avancarCarrinho = async (dbId) => {
            const lead = allLeads.find(l => l.dbId === dbId);
            let tent = (lead.tentativas || 0) + 1;
            let addDays = tent === 1 ? 2 : (tent === 2 ? 3 : 5);
            let d = new Date(); d.setDate(d.getDate() + addDays);
            let nextD = d.toISOString().split('T')[0];
            let novoHist = [...(lead.historico||[]), { data: hoje, acao: `Enviada Mensagem ${tent}`, tag: 'Atualizado' }];
            
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leads_v2', dbId), {
                tentativas: tent, proxRetorno: nextD, historico: novoHist
            });
            window.open(`https://wa.me/${lead.telefone.replace(/\D/g,'')}?text=Ol√° ${lead.nome.split(' ')[0]}, vi que deixou itens no carrinho! Posso ajudar?`, '_blank');
        };

        window.atualizarTag = async (dbId, tag) => {
            if(!tag) return;
            const lead = allLeads.find(l => l.dbId === dbId);
            let d = new Date(); d.setDate(d.getDate() + 2);
            let nextD = tag === 'Convertido' ? '' : d.toISOString().split('T')[0];
            let novoHist = [...(lead.historico||[]), { data: hoje, acao: `Mudan√ßa de Tag`, tag: tag }];
            
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leads_v2', dbId), {
                tag: tag, proxRetorno: nextD, historico: novoHist, status: tag === 'Convertido' ? 'Convertido' : lead.status
            });
        };

        window.registarCompra = async (dbId) => {
            if(confirm('Registar nova compra para este cliente hoje? Isto ir√° atualizar o status para P√≥s-Venda.')) {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leads_v2', dbId), {
                    dataUltimaCompra: hoje, proxRetorno: hoje
                });
                showToast("Compra registada! Cliente transferido para P√≥s-Venda.");
            }
        };

        window.filtrarBase = () => {
            const txt = document.getElementById('filtro-base').value.toLowerCase();
            const tipo = document.getElementById('filtro-tipo').value;
            document.querySelectorAll('.row-base').forEach(row => {
                const rTxt = row.getAttribute('data-nome') + row.getAttribute('data-tel');
                const rTipo = row.getAttribute('data-tipo');
                row.style.display = (!txt || rTxt.includes(txt)) && (!tipo || rTipo === tipo) ? '' : 'none';
            });
        }

        // --- IMPORT & CREATION ---
        window.openImportModal = () => document.getElementById('modal-import').classList.remove('hidden', 'flex'), document.getElementById('modal-import').classList.add('flex');
        window.openNovoLeadModal = () => document.getElementById('modal-novo-lead').classList.remove('hidden', 'flex'), document.getElementById('modal-novo-lead').classList.add('flex');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden'), document.getElementById(id).classList.remove('flex');

        window.salvarNovoLead = async () => {
            const n = document.getElementById('fnome').value, t = document.getElementById('ftel').value;
            const tipo = document.getElementById('ftipo').value, orig = document.getElementById('forigem').value;
            if(!n || !t) { showToast("Nome e Telefone requeridos.", "warning"); return; }
            
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leads_v2', 'ld_'+Date.now()), {
                nome: n, telefone: t, tipoCliente: tipo, origem: orig, dataEntrada: hoje, historico: []
            });
            showToast("Cliente registado com sucesso!");
            closeModal('modal-novo-lead');
        };

        // --- SISTEMA DE IMPORTA√á√ÉO BLINDADO ---

        // M√©todo 1: Puxar Ficheiros da Pasta (Fetch)
        window.puxarDaPasta = async (fileName, layoutType, clienteType) => {
            try {
                showToast(`A tentar ler ${fileName} da pasta...`, "info");
                
                // Tenta puxar o ficheiro na mesma diretoria
                const response = await fetch(`./${fileName}`);
                
                if (!response.ok) {
                    throw new Error(`Ficheiro n√£o encontrado ou bloqueado pelo navegador.`);
                }
                
                const textoCSV = await response.text();
                
                if(!textoCSV || textoCSV.trim() === '') {
                    showToast(`O ficheiro ${fileName} est√° vazio!`, "warning");
                    return;
                }

                // Envia para o processador central
                await processarTextoCSV(textoCSV, layoutType, clienteType);

            } catch (error) {
                console.error("Erro no Fetch:", error);
                showToast(`Falha a ler da pasta. Motivo prov√°vel: Seguran√ßa do Navegador bloqueou o ficheiro. Use a op√ß√£o 'Copiar e Colar'.`, "error");
            }
        };

        // M√©todo 2: Processar texto colado na TextArea
        window.processarTextoColado = async () => {
            const texto = document.getElementById('texto-csv').value;
            const layout = document.getElementById('colar-layout').value;
            const tipo = document.getElementById('colar-tipo').value;

            if(!texto || texto.trim() === '') {
                showToast("Por favor, cole os dados na caixa de texto primeiro.", "warning");
                return;
            }

            await processarTextoCSV(texto, layout, tipo);
            // Limpar textarea ap√≥s uso com sucesso
            document.getElementById('texto-csv').value = '';
        };

        // O Motor Central de Processamento de Dados (Anti-Duplicados)
        async function processarTextoCSV(text, layout, tipoBase) {
            const loader = document.getElementById('loading-screen');
            const loaderText = document.getElementById('global-loading-text');
            
            loader.classList.remove('hidden');
            loaderText.innerText = "A validar dados...";

            try {
                // Separa por linhas (suporta Mac, Windows, Linux)
                const lines = text.split(/\r\n|\n|\r/);
                if(lines.length < 1) throw new Error("Ficheiro vazio");

                let countImported = 0;
                let countDuplicates = 0;
                let countInvalid = 0;
                let promisesBatch = [];
                
                // Set para cruzar e bloquear os duplicados rapidamente
                const telefonesExistentes = new Set(allLeads.map(l => l.telefone));
                const telefonesNesteLote = new Set(); 

                // Identificar o Separador (Toler√¢ncia a v√≠rgulas, ponto e v√≠rgula e tabula√ß√£o)
                const sample = lines.slice(0, Math.min(10, lines.length)).join('\n');
                let sep = '\t';
                if(sample.split(';').length > sample.split('\t').length) sep = ';';
                if(sample.split(',').length > sample.split(';').length && sample.split(',').length > sample.split('\t').length) sep = ',';

                for(let i = 0; i < lines.length; i++) { 
                    const line = lines[i].trim();
                    if(!line) continue;
                    
                    const cols = line.split(sep).map(c => c.trim().replace(/^["']|["']$/g, ''));
                    
                    // Ignora cabe√ßalhos
                    if (cols.some(c => c.toLowerCase().includes('c√≥digo') || c.toLowerCase().includes('nome') || c.toLowerCase() === 'cnpj' || c.toLowerCase().includes('telefone'))) {
                        continue;
                    }

                    let n = '', t = '', uf = '', origem = '', ultimaCompra = null, tag = 'Novo';
                    
                    if (layout === 'clientes') {
                        n = cols[3] || cols[4] || ''; 
                        t = cols[13] || cols[14] || ''; 
                        uf = cols[9] || ''; 
                        origem = 'Base Antiga';
                        if (cols[15] && cols[15].includes('/')) {
                            const parts = cols[15].split(' ')[0].split('/');
                            if (parts.length === 3) ultimaCompra = `${parts[2]}-${parts[1]}-${parts[0]}`;
                        }
                    } else if (layout === 'leads') {
                        n = cols[2] || cols[1] || ''; 
                        t = cols[8] || cols[9] || ''; 
                        uf = cols[7] || ''; 
                        origem = 'Comprado'; 
                    } else if (layout === 'simples') {
                        n = cols[0] || '';
                        t = cols[1] || '';
                        origem = 'Importa√ß√£o Manual';
                    }
                    
                    // CA√áADOR DE NOMES
                    if (!n || n.length < 2 || n === 'Cliente Desconhecido') {
                        const potentialName = cols.find(c => c && !c.includes('@') && !c.includes('//') && c.replace(/\D/g, '').length < 8 && c.trim().length > 2 && isNaN(c));
                        n = potentialName ? potentialName.trim() : 'Cliente Sem Nome';
                    }

                    // CA√áADOR DE TELEFONES
                    let cleanPhone = t.replace(/\D/g, '');
                    if (cleanPhone.length < 10) {
                        const potentialPhone = cols.find(c => {
                            if(!c) return false;
                            if(c.includes('@') || c.includes('//') || c.toLowerCase().includes('rua') || c.toLowerCase().includes('cep')) return false;
                            const digits = c.replace(/\D/g, '');
                            return digits.length >= 10 && digits.length <= 15 && !c.toLowerCase().includes('cnpj');
                        });
                        if (potentialPhone) cleanPhone = potentialPhone.replace(/\D/g, '');
                    }

                    // VALIDA√á√ÉO & INSER√á√ÉO
                    if(cleanPhone.length >= 10 && cleanPhone.length <= 15) { 
                        
                        // Verifica duplica√ß√£o no banco de dados E no lote atual
                        if (telefonesExistentes.has(cleanPhone) || telefonesNesteLote.has(cleanPhone)) {
                            countDuplicates++;
                        } else {
                            telefonesNesteLote.add(cleanPhone); // Marca como processado
                            
                            const docId = 'imp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                            
                            promisesBatch.push(
                                setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leads_v2', docId), {
                                    nome: n, telefone: cleanPhone, uf: uf, tipoCliente: tipoBase, origem: origem, 
                                    dataEntrada: hoje, dataUltimaCompra: ultimaCompra, tag: tag, historico: []
                                })
                            );
                            countImported++;
                            
                            // Guardar no Firebase aos poucos (em pacotes de 100) para n√£o travar
                            if (promisesBatch.length >= 100) {
                                loaderText.innerText = `A guardar... (${countImported} salvos)`;
                                await Promise.all(promisesBatch);
                                promisesBatch = [];
                            }
                        }
                    } else {
                        countInvalid++;
                    }
                }
                
                // Guardar o resto do pacote final
                if (promisesBatch.length > 0) {
                    loaderText.innerText = `A finalizar... (${countImported} salvos)`;
                    await Promise.all(promisesBatch);
                }
                
                showToast(`Sucesso! ${countImported} novos salvos. (${countDuplicates} duplicados ignorados, ${countInvalid} inv√°lidos)`, countImported > 0 ? 'success' : 'warning');
                closeModal('modal-import');
                
                // Atualiza a vista se estiver na tab correspondente
                if (currentView === 'base' || currentView === 'comprados') renderCurrentView();
                
            } catch (error) {
                console.error("Erro importa√ß√£o:", error);
                showToast("Erro cr√≠tico a processar texto. Estrutura inv√°lida.", "error");
            } finally {
                loader.classList.add('hidden');
            }
        }

        // --- UTILS ---
        function formatDate(ds) { if(!ds) return ''; const [y,m,d] = ds.split('-'); return `${d}/${m}`; }
        function getClasseColor(c) {
            const map = { 'Novo Lead':'text-amber-500', 'Ativo':'text-emerald-500', 'P√≥s-Venda':'text-brand-500', 'Risco Inatividade':'text-orange-500', 'Inativo':'text-apple-textMut' };
            return map[c] || 'text-apple-textMut';
        }
    </script>
</body>
</html>
